package {{Package}}

import pl.wendigo.chrome.protocol.DebuggerProtocol
import java.io.Closeable

/**
 * ChromeProtocol represents session established via given protocol websocket connection (via target or inspectable page).
 */
open class ChromeProtocol internal constructor(private val api: DebuggerProtocol): Closeable {

    /**
     * Register events mappings.
     */
    init {
        api.registerEventMappings(mapOf(
        {{#each Protocol.EventMappings}}
            "{{EventName}}" to {{Class}}::class.java{{#unless @last}},{{/unless}}
        {{/each}}
        ))
    }

    {{#each Protocol.Domains}}
    /**
     * {{#if Description}}{{{Description}}}{{else}}Returns {{Name}} domain object.{{/if}}
     */
    val {{Name}} : {{Package}}.domain.{{LowerName}}.{{Name}}Domain by lazy {
        {{Package}}.domain.{{LowerName}}.{{Name}}Domain(api)
    }

    {{/each}}
    /**
     * Returns [Flowable] capturing all events.
     */
    fun Events() : io.reactivex.Flowable<ProtocolEvent> {
        return api.captureAllEvents().map {
            it.value()
        }
    }

    /**
     * Closes session.
     */
    override fun close() {
        return api.close()
    }
}